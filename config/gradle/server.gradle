def serverConfig = {};

def addServer(serverIp,
              serverUser,
              serverRole) {
    println "Adding server, ip:${serverIp}, user:${serverUser}, role:${serverRole}"
    remotes {
        "${serverIp}" {
            role("${serverRole}")
            role("all")
            host = "${serverIp}"
            user = "${serverUser}"
            identity = file("${System.properties['user.home']}/.ssh/id_rsa")
        }
    }
}

def addTestServer(serverIp,
                  serverUser) {
    addServer(serverIp, serverUser, 'test')
}

def addProductionServer(serverIp,
                        serverUser) {
    addServer(serverIp, serverUser, 'production')
}

def execCmd = { command ->
    def stdout = new ByteArrayOutputStream()
    exec {
        commandLine command
        standardOutput = stdout
    }
    return stdout.toString().trim()
}

task updateServerClasses() {
    dependsOn 'updateClassesFiles'
    doLast {
        execCmd(['rsync', '--delete', '-ru', "/tmp/java-app-classes/${project.name}/.".toString(),
                 "${server}:~/deploy/docker-container/${project.name}/app".toString()
        ])
    }
}


ext {
    addTestServer = this.&addTestServer
    addProductionServer = this.&addProductionServer
    addServer = this.&addServer
}

