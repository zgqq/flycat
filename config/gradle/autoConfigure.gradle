import groovy.json.JsonSlurper
def jsonSlurper = new JsonSlurper()

def configFile = "./config.json"
if (hasProperty("config")) {
    configFile = config
}

def fileObj = new File(configFile)
if (!fileObj.isFile()) {
    println("Not found config file " + configFile)
    return
}

def data = jsonSlurper.parse(fileObj)

//if (hasProperty("configKey")) {
//    data = data[configKey]
//}

//get_data_value(key, env) {
//    if 'env_overwrite' in data.keys() and env in data['env_overwrite']:
//    if key in data['env_overwrite'][env].keys():
//    return data['env_overwrite'][env][key]
//    return data[key]
//}

println("Read config: ${data}")
//rootProject.name = data['app_name']

def appPort= data['app_port'].toString()
def appName= data['app_name'].toString()
def dockerRepo= data['docker_repo'].toString()
def mainClass= data['main_class'].toString()


ext.containerPort = appPort
ext.dockerImage = dockerRepo
ext.appClassName = mainClass


if (hasProperty('customJvmArgs')) {
    ext.customJvmArgs += ["-Dserver.port=${appPort}".toString(), "-Dspring.application.name=${appName}".toString()]
} else {
    ext.customJvmArgs = ["-Dserver.port=${appPort}".toString(), "-Dspring.application.name=${appName}".toString()]
}


ext.addCustomJvmArgs = { argsArr ->
    if (project.hasProperty('customJvmArgs')) {
        ext.customJvmArgs += argsArr
    } else {
        ext.customJvmArgs = argsArr
    }
}


if (data.containsKey('app_debug_port')) {
    ext.debugPort=data['app_debug_port'].toString()
}


ext.getConfigValue = { configData, key, env ->
    env = env.toString()
    // Method body here
    println("getConfigValue ${key}, ${env}")
//    if ('env_overwrite' in configData.keySet() && env in configData['env_overwrite']) {
//        if (key in configData['env_overwrite'][env].keySet())
//            return configData['env_overwrite'][env][key]
//    }
    if ('env_overwrite' in configData.keySet() && configData['env_overwrite'].containsKey(env)) {
        if (key in configData['env_overwrite'][env].keySet())
            return configData['env_overwrite'][env][key]
    }
    return configData[key]

    return configData[key]
}


ext.getSubConfigValue = { name, key, env ->
    env = env.toString()
    println("getSubConfigValue ${name}, ${key}, ${env} ")
    if (name in data.keySet()) {
        def configData = data[name]
//        def arr = ['local', 'dev']
//        println("get env_overwrite ${name}, ${key}, env:${env}, ${configData['env_overwrite'].keySet()}," +
//                "${'env_overwrite' in configData.keySet()},env in env_overwrite:${env.toString() in configData['env_overwrite'].keySet()}, " +
//                "${'local' in arr}, ${arr}, ss${configData['env_overwrite'].containsKey(env)}")
        return getConfigValue(configData, key, env)
    }
    return null
}

if (getSubConfigValue('infra_redis', 'enable', env)) {
    def host = getSubConfigValue('infra_redis', 'host', env)
    def password = getSubConfigValue('infra_redis', 'password', env)
    def port = getSubConfigValue('infra_redis', 'port', env)
    addCustomJvmArgs(["-Dflycat.redis.primary.enabled=true",
                      "-Dflycat.redis.primary.host=${host}".toString(),
                      "-Dflycat.redis.primary.port=${port}".toString(),
                      "-Dflycat.redis.primary.password=${password}".toString()])
//    flycat.redis.primary.enabled=true
//    flycat.redis.primary.host=localhost
//    flycat.redis.primary.port=6380
}


if (!isRunUnitTest()) {
    if (!getConfigValue(data, 'run_test', env)){
        println("Disable test in ${env} env")
        test.enabled = false
    }
}

//def executeDockerBuild = false
//def executingTasks = project.gradle.startParameter.taskNames
//if (executingTasks != null && !executingTasks.isEmpty()) {
//    executeDockerBuild = 'jib' in executingTasks
//            || 'jibDockerbuild' in executingTasks
//}


//println("Executing docker build, ${executeDockerBuild}, ${executingTasks}")
if (isDockerBuild()) {
    ext.profile = getSubConfigValue('docker_profiles', env.toString(), env)
    println("Executing docker build, use profile:${profile}")
}
